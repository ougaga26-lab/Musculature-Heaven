<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musculature Heaven</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #2c5f7c;
            --secondary: #8b4f4b;
            --accent: #d4a373;
            --success: #4caf50;
            --card: #ffffff;
            --text: #2a2a2a;
            --border: #d4cfc4;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #f8f6f3 0%, #ebe8e1 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 1rem;
        }

        .container { max-width: 800px; margin: 0 auto; }

        /* â”€â”€â”€ æ¨™é¡Œ â”€â”€â”€ */
        .header { text-align: center; margin-bottom: 2rem; }
        h1 {
            font-family: 'Crimson Pro', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.3rem;
        }
        .subtitle { font-size: 1rem; color: var(--secondary); }

        /* â”€â”€â”€ ç¯©é¸å™¨ â”€â”€â”€ */
        .controls {
            background: var(--card);
            border-radius: 15px;
            padding: 1.2rem 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        .filter-buttons {
            display: flex;
            gap: 0.75rem;
            width: 100%;
            align-items: center;
        }

        /* å…¨éƒ¨ â€” å±¤ç´šé«˜ï¼Œæ›´é¡¯è‘— */
        .filter-btn-all {
            padding: 0.75rem 1.4rem;
            border: 2.5px solid var(--primary);
            background: rgba(44,95,124,0.08);
            border-radius: 14px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1rem;
            color: var(--primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.2rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        .filter-btn-all .filter-count {
            font-size: 0.72rem;
            color: rgba(44,95,124,0.55);
            font-weight: 600;
        }
        .filter-btn-all.active {
            background: var(--primary);
            color: white;
        }
        .filter-btn-all.active .filter-count {
            color: rgba(255,255,255,0.7);
        }

        /* å­é¡åˆ¥ */
        .filter-sub-group { display: flex; gap: 0.5rem; flex: 1; }

        .filter-btn {
            padding: 0.5rem 0.4rem;
            border: 1.5px solid var(--border);
            background: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.15rem;
            flex: 1;
            min-width: 0;
        }
        .filter-btn .filter-label { font-size: 0.8rem; white-space: nowrap; }
        .filter-btn .filter-count { font-size: 0.68rem; color: #999; font-weight: 600; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .filter-btn.active .filter-count { color: rgba(255,255,255,0.7); }

        /* â”€â”€â”€ å¡ç‰‡ â”€â”€â”€ */
        .card-container { perspective: 1000px; margin-bottom: 2rem; }
        .flashcard {
            width: 100%; height: 500px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }
        .flashcard.flipped { transform: rotateY(180deg); }
        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 2rem;
            background: var(--card);
        }
        .card-front { background: linear-gradient(135deg, #fff 0%, #f8f6f3 100%); }
        .card-back  { transform: rotateY(180deg); background: linear-gradient(135deg, #f8f6f3 0%, #fff 100%); }
        .card-image {
            max-width: 100%; max-height: 300px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            object-fit: contain;
        }
        .card-title {
            font-family: 'Crimson Pro', serif;
            font-size: 2rem; font-weight: 700;
            color: var(--primary); text-align: center; margin-bottom: 0.5rem;
        }
        .card-subtitle { font-size: 1.3rem; color: var(--secondary); text-align: center; font-weight: 500; }
        .card-info { width: 100%; text-align: left; overflow-y: auto; max-height: 200px; }
        .info-item { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .info-item:last-child { border-bottom: none; }
        .info-label { font-weight: 700; color: var(--primary); margin-bottom: 0.3rem; font-size: 0.9rem; }
        .info-content { color: var(--text); line-height: 1.6; white-space: pre-line; font-size: 0.95rem; }
        .flip-hint {
            position: absolute; bottom: 1rem; left: 50%;
            transform: translateX(-50%);
            font-size: 0.85rem; color: #999;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%,100%{opacity:.5} 50%{opacity:1} }

        /* â”€â”€â”€ ç†Ÿæ‚²æŒ‰éˆ• â”€â”€â”€ */
        .actions { display: flex; gap: 1rem; justify-content: center; margin-bottom: 2rem; }
        .action-btn {
            padding: 0.8rem 2rem; border: none; border-radius: 50px;
            font-weight: 600; font-size: 1rem; cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .btn-unfamiliar { background: var(--secondary); color: white; }
        .btn-unfamiliar:hover { background: #6d3d39; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(139,79,75,0.3); }
        .btn-familiar  { background: var(--success); color: white; }
        .btn-familiar:hover  { background: #45a049; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(76,175,80,0.3); }

        /* â”€â”€â”€ å°èˆª â”€â”€â”€ */
        .navigation {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card); border-radius: 15px;
            padding: 1rem 1.5rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        .nav-btn {
            padding: 0.6rem 1.5rem; background: var(--accent); color: white;
            border: none; border-radius: 25px; font-weight: 600;
            cursor: pointer; transition: all 0.3s ease;
        }
        .nav-btn:hover:not(:disabled) { background: #c9956a; transform: translateY(-2px); }
        .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* â”€â”€â”€ å­¸ç¿’æˆæ•ˆæŒ‰éˆ• â”€â”€â”€ */
        .stats-btn-wrap { text-align: center; margin-top: 1.5rem; }
        .stats-btn {
            padding: 0.8rem 2rem; background: var(--primary); color: white;
            border: none; border-radius: 25px; font-weight: 600; font-size: 1rem;
            cursor: pointer; transition: all 0.3s ease;
        }
        .stats-btn:hover { background: #1e4a5f; transform: translateY(-2px); }

        /* â”€â”€â”€ Loading â”€â”€â”€ */
        .loading { text-align: center; padding: 3rem; font-size: 1.2rem; color: var(--primary); }
        .spinner {
            border: 4px solid var(--border); border-top: 4px solid var(--primary);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 0 auto 1rem;
        }
        @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }

        /* â”€â”€â”€ ç©ºé¡åˆ¥è¨Šæ¯ â”€â”€â”€ */
        .empty-msg {
            display: none; text-align: center;
            padding: 5rem 2rem;
            background: var(--card); border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }
        .empty-msg .emoji { font-size: 3rem; margin-bottom: 1rem; }
        .empty-msg p { font-size: 1.2rem; color: var(--primary); font-weight: 600; }
        .empty-msg .sub { font-size: 0.9rem; color: #999; margin-top: 0.5rem; font-weight: 400; }

        /* â”€â”€â”€ å­¸ç¿’æˆæ•ˆé é¢ â”€â”€â”€ */
        .stats-page { display: none; }
        .stats-page-inner {
            background: var(--card); border-radius: 20px; padding: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }
        .stats-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .stats-header h2 { font-family: 'Crimson Pro', serif; font-size: 2rem; color: var(--primary); margin: 0; }
        .stats-summary { display: grid; grid-template-columns: repeat(3,1fr); gap: 1rem; margin-bottom: 2rem; }
        .stats-card { color: white; padding: 1.5rem; border-radius: 15px; text-align: center; }
        .stats-card .num { font-size: 2.5rem; font-weight: 700; }
        .stats-card .label { font-size: 0.9rem; opacity: 0.9; }
        .stats-section { margin-bottom: 2.5rem; }
        .stats-section:last-child { margin-bottom: 0; }
        .stats-section h3 {
            font-family: 'Crimson Pro', serif; font-size: 1.5rem;
            margin-bottom: 1rem; padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border);
        }
        .stats-list-item {
            display: flex; align-items: center;
            padding: 0.9rem 1rem; background: white;
            border-radius: 10px; margin-bottom: 0.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .stats-list-item img {
            width: 75px; height: 75px; object-fit: cover;
            border-radius: 8px; margin-right: 1rem; flex-shrink: 0;
        }
        .stats-list-item .info { flex: 1; min-width: 0; }
        .stats-list-item .name-en { font-weight: 600; font-size: 1.05rem; color: var(--primary); }
        .stats-list-item .name-zh { color: var(--secondary); font-size: 0.9rem; }
        .stats-list-item .badge {
            color: white; padding: 0.4rem 0.9rem; border-radius: 20px;
            font-weight: 600; font-size: 0.85rem; white-space: nowrap; flex-shrink: 0;
        }
        .stats-empty { text-align: center; color: #999; padding: 1.5rem; }

        /* â”€â”€â”€ æ‰‹æ©Ÿç‰ˆ â”€â”€â”€ */
        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .flashcard { height: 450px; }
            .card-title { font-size: 1.8rem; }
            .card-subtitle { font-size: 1.2rem; }
            .filter-buttons { flex-wrap: wrap; }
            .filter-btn-all { flex: none; }
            .filter-sub-group { flex: 1; min-width: 100%; }
            .actions { flex-direction: column; }
            .action-btn { width: 100%; }
        }
    </style>
</head>
<body>
<div class="container">

    <!-- æ¨™é¡Œ -->
    <div class="header">
        <h1>Musculature Heaven</h1>
        <p class="subtitle">è‚Œè‚‰è§£å‰–å­¸è¤‡ç¿’å°å¤©å ‚</p>
    </div>

    <!-- Loading -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>è¼‰å…¥è³‡æ–™ä¸­...</p>
    </div>

    <!-- ç©ºé¡åˆ¥è¨Šæ¯ï¼ˆé»é€²ç©ºçš„ç¯©é¸å™¨æ™‚å‡ºç¾ï¼‰ -->
    <div id="emptyMsg" class="empty-msg">
        <div class="emoji">ğŸ“­</div>
        <p>ä½ é‚„æ²’æœ‰ç´€éŒ„å–”</p>
        <p class="sub">3 ç§’å¾Œè‡ªå‹•å›åˆ°å…¨éƒ¨...</p>
    </div>

    <!-- ä¸»é é¢ -->
    <div id="app" style="display:none;">
        <!-- ç¯©é¸å™¨ -->
        <div class="controls">
            <div class="filter-buttons">
                <button class="filter-btn-all active" data-filter="all">
                    <span>å…¨éƒ¨</span>
                    <span class="filter-count" id="countAll">0</span>
                </button>
                <div class="filter-sub-group">
                    <button class="filter-btn" data-filter="unfamiliar">
                        <span class="filter-label">âŒ é‚„ä¸ç†Ÿ</span>
                        <span class="filter-count" id="countUnfamiliar">0</span>
                    </button>
                    <button class="filter-btn" data-filter="familiar">
                        <span class="filter-label">âœ… ç†Ÿæ‚²äº†</span>
                        <span class="filter-count" id="countFamiliar">0</span>
                    </button>
                    <button class="filter-btn" data-filter="unseen">
                        <span class="filter-label">ğŸ‘€ é‚„æ²’çœ‹</span>
                        <span class="filter-count" id="countUnseen">0</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- å¡ç‰‡ -->
        <div class="card-container">
            <div class="flashcard" id="flashcard">
                <div class="card-face card-front">
                    <img id="cardImage" class="card-image" alt="Muscle" style="max-height:90%;margin:0;">
                    <div class="flip-hint">ğŸ‘† é»æ“Šç¿»è½‰æŸ¥çœ‹è³‡è¨Š</div>
                </div>
                <div class="card-face card-back">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2rem;width:100%;margin-bottom:1.5rem;">
                        <div style="display:flex;align-items:center;justify-content:center;">
                            <img id="cardImageBack" class="card-image" alt="Muscle" style="max-height:200px;margin:0;">
                        </div>
                        <div style="display:flex;flex-direction:column;justify-content:center;">
                            <h2 class="card-title" id="cardTitleEN">Muscle Name</h2>
                            <p class="card-subtitle" id="cardTitleZH">è‚Œè‚‰åç¨±</p>
                        </div>
                    </div>
                    <div class="card-info" id="cardInfo"></div>
                    <div class="flip-hint">ğŸ‘† é»æ“Šç¿»å›æ­£é¢</div>
                </div>
            </div>
        </div>

        <!-- ç†Ÿæ‚²æŒ‰éˆ• -->
        <div class="actions">
            <button class="action-btn btn-unfamiliar" id="btnUnfamiliar">âŒ é‚„ä¸ç†Ÿ</button>
            <button class="action-btn btn-familiar"   id="btnFamiliar">âœ… ç†Ÿæ‚²äº†</button>
        </div>

        <!-- å°èˆª -->
        <div class="navigation">
            <button class="nav-btn" id="btnPrev">â† ä¸Šä¸€å¼µ</button>
            <button class="nav-btn" id="btnNext">ä¸‹ä¸€å¼µ â†’</button>
        </div>

        <!-- å­¸ç¿’æˆæ•ˆæŒ‰éˆ•ï¼ˆå”¯ä¸€ä¸€å€‹ï¼Œæ”¾åœ¨æœ€ä¸‹é¢ï¼‰ -->
        <div class="stats-btn-wrap">
            <button class="stats-btn" id="btnStats">ğŸ“Š æˆ‘çš„å­¸ç¿’æˆæ•ˆ</button>
        </div>
    </div>

    <!-- å­¸ç¿’æˆæ•ˆé é¢ -->
    <div id="statsPage" class="stats-page">
        <div class="stats-page-inner">
            <div class="stats-header">
                <h2>ğŸ“Š æˆ‘çš„å­¸ç¿’æˆæ•ˆ</h2>
                <button class="nav-btn" id="btnBackToMain" style="background:var(--accent);">â† è¿”å›ä¸»é </button>
            </div>
            <div class="stats-summary">
                <div class="stats-card" style="background:linear-gradient(135deg,var(--primary),#1e4a5f);">
                    <div class="num" id="statsTotal">0</div><div class="label">ç¸½é¡Œæ•¸</div>
                </div>
                <div class="stats-card" style="background:linear-gradient(135deg,var(--success),#45a049);">
                    <div class="num" id="statsFamiliar">0</div><div class="label">å·²ç†Ÿæ‚²</div>
                </div>
                <div class="stats-card" style="background:linear-gradient(135deg,var(--secondary),#6d3d39);">
                    <div class="num" id="statsUnfamiliar">0</div><div class="label">é‚„ä¸ç†Ÿ</div>
                </div>
            </div>
            <div class="stats-section">
                <h3 style="color:var(--secondary);">âŒ æˆ‘æœ€å¸¸éŒ¯çš„ï¼ˆå‰ 10 åï¼‰</h3>
                <div id="mostWrongList"></div>
            </div>
            <div class="stats-section">
                <h3 style="color:var(--success);">âœ… æˆ‘æœ€ç†Ÿçš„ï¼ˆå‰ 10 åï¼‰</h3>
                <div id="mostCorrectList"></div>
            </div>
        </div>
    </div>

</div><!-- /container -->

<script>
// â”€â”€â”€ å¸¸æ•¸ â”€â”€â”€
const GITHUB_USER = 'ougaga26-lab';
const REPO_NAME   = 'Musculature-Heaven';
const RAW_BASE    = `https://raw.githubusercontent.com/${GITHUB_USER}/${REPO_NAME}/main/`;
const CSV_PATH    = 'data/muscles.csv';
const IMG_PATH    = 'images/';

// â”€â”€â”€ ç‹€æ…‹ â”€â”€â”€
let allCards      = [];
let cardQueue     = [];
let currentIndex  = 0;
let currentFilter = 'all';
let familiarityData = {};   // { filename: 'unseen' | 'unfamiliar' | 'familiar' }
let statsData       = {};   // { filename: { wrong, correct, nameEN, nameZH, image } }

// â”€â”€â”€ localStorage â”€â”€â”€
function loadSaved() {
    try { familiarityData = JSON.parse(localStorage.getItem('musculature_familiarity')) || {}; } catch(e){}
    try { statsData       = JSON.parse(localStorage.getItem('musculature_stats'))       || {}; } catch(e){}
}
function saveSaved() {
    localStorage.setItem('musculature_familiarity', JSON.stringify(familiarityData));
    localStorage.setItem('musculature_stats',       JSON.stringify(statsData));
}

// â”€â”€â”€ CSV è§£æï¼ˆè™•ç†å¼•è™Ÿå…§æ›è¡Œ + æ¸…é™¤ \rï¼‰ â”€â”€â”€
function parseCSV(text) {
    text = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n');
    const lines   = text.split('\n');
    const headers = parseCSVLine(lines[0]);
    const data    = [];
    let i = 1;
    while (i < lines.length) {
        if (!lines[i].trim()) { i++; continue; }
        let row = lines[i];
        let qc  = (row.match(/"/g)||[]).length;
        while (qc % 2 !== 0 && i+1 < lines.length) { i++; row += '\n'+lines[i]; qc = (row.match(/"/g)||[]).length; }
        const vals = parseCSVLine(row);
        if (vals.length === headers.length) {
            const obj = {};
            headers.forEach((h,idx) => obj[h] = vals[idx]);
            data.push(obj);
        }
        i++;
    }
    return data;
}
function parseCSVLine(line) {
    const vals = []; let cur = '', inQ = false;
    for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch==='"') { if (inQ && line[i+1]==='"') { cur+='"'; i++; } else inQ=!inQ; }
        else if (ch===',' && !inQ) { vals.push(cur.trim()); cur=''; }
        else cur += ch;
    }
    vals.push(cur.trim());
    return vals;
}

// â”€â”€â”€ è¼‰å…¥ â”€â”€â”€
async function loadData() {
    try {
        const res  = await fetch(RAW_BASE + CSV_PATH);
        const text = await res.text();
        allCards   = parseCSV(text);

        // æ–°å¡ç‰‡é è¨­ unseen
        allCards.forEach(c => { if (!familiarityData[c['picture file']]) familiarityData[c['picture file']] = 'unseen'; });

        applyFilter();
        updateProgress();
        showCard(0);

        document.getElementById('loading').style.display = 'none';
        document.getElementById('app').style.display     = 'block';
    } catch(err) {
        document.getElementById('loading').innerHTML = `<p style="color:#c00;">è¼‰å…¥å¤±æ•—ï¼</p><p style="font-size:.9rem;margin-top:.5rem;">${err.message}</p>`;
    }
}

// â”€â”€â”€ ç¯©é¸ â”€â”€â”€
function applyFilter() {
    const filtered = currentFilter === 'all'
        ? [...allCards]
        : allCards.filter(c => familiarityData[c['picture file']] === currentFilter);
    cardQueue    = shuffleArray(filtered);
    currentIndex = 0;
}
function shuffleArray(arr) {
    const a = [...arr];
    for (let i = a.length-1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a;
}

// è¤‡ç¿’æ’å…¥ï¼ˆæ¯ 3 å¼µå¾Œå†å‡ºç¾ï¼‰â€” åªåœ¨ã€Œå…¨éƒ¨ã€æ¨¡å¼è§¸ç™¼
function insertReviewCard(card) {
    cardQueue.splice(Math.min(currentIndex+3, cardQueue.length), 0, card);
}

// â”€â”€â”€ é¡¯ç¤ºå¡ç‰‡ â”€â”€â”€
const FALLBACK_IMG = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="200"><rect width="300" height="200" fill="%23ddd"/><text x="150" y="100" text-anchor="middle" fill="%23999" font-size="16">åœ–ç‰‡è¼‰å…¥å¤±æ•—</text></svg>';

function showCard(idx) {
    if (!cardQueue.length) return;
    const card = cardQueue[idx];
    const url  = RAW_BASE + IMG_PATH + card['picture file'];

    ['cardImage','cardImageBack'].forEach(id => {
        const el = document.getElementById(id);
        el.src = url;
        el.onerror = function(){ this.src = FALLBACK_IMG; };
    });

    document.getElementById('cardTitleEN').textContent = card['name (EN)'] || '';
    document.getElementById('cardTitleZH').textContent = card['name (CN)'] || '';

    document.getElementById('cardInfo').innerHTML = [
        ['Origin / èµ·å§‹é»',    card['Origin'],    card['èµ·å§‹é»']],
        ['Insertion / çµæŸé»', card['Insertion'], card['çµæŸé»']],
        ['Action / å‹•ä½œ',      card['Action'],    card['å‹•ä½œ']],
        ['Nerve / ç¥ç¶“æ”¯é…',   card['Nerve'],     card['ç¥ç¶“æ”¯é…']]
    ].map(([label,en,zh]) =>
        `<div class="info-item"><div class="info-label">${label}</div><div class="info-content">${en||''}\n${zh||''}</div></div>`
    ).join('');

    document.getElementById('flashcard').classList.remove('flipped');
    document.getElementById('btnPrev').disabled = idx === 0;
    document.getElementById('btnNext').disabled = idx === cardQueue.length - 1;

    const isFam = familiarityData[card['picture file']] === 'familiar';
    document.getElementById('btnFamiliar').style.opacity   = isFam ? '1' : '0.5';
    document.getElementById('btnUnfamiliar').style.opacity = isFam ? '0.5' : '1';
}

// â”€â”€â”€ æ›´æ–°ç¯©é¸å™¨æ•¸å­— â”€â”€â”€
function updateProgress() {
    const total = allCards.length;
    const fam   = allCards.filter(c => familiarityData[c['picture file']] === 'familiar').length;
    const unfam = allCards.filter(c => familiarityData[c['picture file']] === 'unfamiliar').length;
    document.getElementById('countAll').textContent        = total;
    document.getElementById('countFamiliar').textContent   = fam;
    document.getElementById('countUnfamiliar').textContent = unfam;
    document.getElementById('countUnseen').textContent     = total - fam - unfam;
}

// â”€â”€â”€ å­¸ç¿’æˆæ•ˆé é¢ â”€â”€â”€
function showStatsPage() {
    document.getElementById('app').style.display       = 'none';
    document.getElementById('statsPage').style.display = 'block';

    document.getElementById('statsTotal').textContent     = allCards.length;
    document.getElementById('statsFamiliar').textContent   = allCards.filter(c => familiarityData[c['picture file']]==='familiar').length;
    document.getElementById('statsUnfamiliar').textContent = allCards.filter(c => familiarityData[c['picture file']]==='unfamiliar').length;

    const renderList = (id, key, label, bg) => {
        const list = Object.values(statsData).filter(s=>s[key]>0).sort((a,b)=>b[key]-a[key]).slice(0,10);
        document.getElementById(id).innerHTML = list.length
            ? list.map(item => `
                <div class="stats-list-item">
                    <img src="${RAW_BASE}${IMG_PATH}${item.image}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2275%22 height=%2275%22><rect width=%2275%22 height=%2275%22 fill=%22%23ddd%22/></svg>'">
                    <div class="info"><div class="name-en">${item.nameEN}</div><div class="name-zh">${item.nameZH}</div></div>
                    <div class="badge" style="background:${bg};">${label} ${item[key]} æ¬¡</div>
                </div>`).join('')
            : '<p class="stats-empty">é‚„æ²’æœ‰ç´€éŒ„</p>';
    };
    renderList('mostWrongList',   'wrong',   'éŒ¯èª¤', 'var(--secondary)');
    renderList('mostCorrectList', 'correct', 'æ­£ç¢º', 'var(--success)');
}

// â”€â”€â”€ äº‹ä»¶ç›£è½ â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
    loadSaved();
    loadData();

    // ç¿»ç‰Œ
    document.getElementById('flashcard').addEventListener('click', e => {
        if (!e.target.classList.contains('action-btn'))
            document.getElementById('flashcard').classList.toggle('flipped');
    });

    // ç¯©é¸å™¨ï¼ˆå…¨éƒ¨ + å­é¡åˆ¥éƒ½å¥—åœ¨é€™è£¡ï¼‰
    const allBtns = document.querySelectorAll('.filter-btn-all, .filter-btn');
    allBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const f = btn.dataset.filter;

            // å­é¡åˆ¥ç‚ºç©º â†’ è¨Šæ¯ + 3ç§’å°å›
            if (f !== 'all') {
                const cnt = allCards.filter(c => familiarityData[c['picture file']] === f).length;
                if (cnt === 0) {
                    document.getElementById('app').style.display     = 'none';
                    document.getElementById('emptyMsg').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('emptyMsg').style.display = 'none';
                        document.getElementById('app').style.display     = 'block';
                        allBtns.forEach(b => b.classList.remove('active'));
                        document.querySelector('[data-filter="all"]').classList.add('active');
                        currentFilter = 'all';
                        applyFilter();
                        showCard(0);
                    }, 3000);
                    return;
                }
            }

            allBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = f;
            applyFilter();
            showCard(0);
        });
    });

    // âŒ é‚„ä¸ç†Ÿ
    document.getElementById('btnUnfamiliar').addEventListener('click', () => {
        const card = cardQueue[currentIndex], fn = card['picture file'];
        familiarityData[fn] = 'unfamiliar';
        if (!statsData[fn]) statsData[fn] = { wrong:0, correct:0, nameEN: card['name (EN)'], nameZH: card['name (CN)'], image: fn };
        statsData[fn].wrong++;
        saveSaved(); updateProgress();

        // è¤‡ç¿’ï¼šåªåœ¨å…¨éƒ¨æ¨¡å¼
        if (currentFilter === 'all') insertReviewCard(card);

        if (currentIndex < cardQueue.length-1) { currentIndex++; showCard(currentIndex); }
        else showCard(currentIndex);
    });

    // âœ… ç†Ÿæ‚²äº†
    document.getElementById('btnFamiliar').addEventListener('click', () => {
        const card = cardQueue[currentIndex], fn = card['picture file'];
        familiarityData[fn] = 'familiar';
        if (!statsData[fn]) statsData[fn] = { wrong:0, correct:0, nameEN: card['name (EN)'], nameZH: card['name (CN)'], image: fn };
        statsData[fn].correct++;
        saveSaved(); updateProgress();

        if (currentIndex < cardQueue.length-1) { currentIndex++; showCard(currentIndex); }
        else showCard(currentIndex);
    });

    // å°èˆªï¼šã€Œé‚„æ²’çœ‹ã€è·³éæ™‚æ¨™è¨˜ç‚ºä¸ç†Ÿæ‚²ï¼Œå…¶ä»–ä¸æ”¹
    document.getElementById('btnPrev').addEventListener('click', () => {
        if (currentIndex > 0) {
            const fn = cardQueue[currentIndex]['picture file'];
            if (familiarityData[fn]==='unseen') { familiarityData[fn]='unfamiliar'; saveSaved(); updateProgress(); }
            currentIndex--; showCard(currentIndex);
        }
    });
    document.getElementById('btnNext').addEventListener('click', () => {
        if (currentIndex < cardQueue.length-1) {
            const fn = cardQueue[currentIndex]['picture file'];
            if (familiarityData[fn]==='unseen') { familiarityData[fn]='unfamiliar'; saveSaved(); updateProgress(); }
            currentIndex++; showCard(currentIndex);
        }
    });

    // å­¸ç¿’æˆæ•ˆ
    document.getElementById('btnStats').addEventListener('click', showStatsPage);
    document.getElementById('btnBackToMain').addEventListener('click', () => {
        document.getElementById('statsPage').style.display = 'none';
        document.getElementById('app').style.display     = 'block';
    });

    // éµç›¤
    document.addEventListener('keydown', e => {
        if (e.key==='ArrowLeft')  document.getElementById('btnPrev').click();
        else if (e.key==='ArrowRight') document.getElementById('btnNext').click();
        else if (e.key===' ') { e.preventDefault(); document.getElementById('flashcard').classList.toggle('flipped'); }
    });
});
</script>
</body>
</html>
